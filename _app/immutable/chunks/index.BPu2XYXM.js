var J=Object.defineProperty;var L=(e,t,r)=>t in e?J(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var b=(e,t,r)=>L(e,typeof t!="symbol"?t+"":t,r);import{d}from"./uPlot.min.D9LKXES3.js";function k(e,t,r=63){return e/(r/100*Math.PI)*t*60}function ae(e,t,r,n=63){return e/60/(t*r)*(n/100*Math.PI)}function N(e,t){return .85}function B(e,t,r){let i=.005+.4*(.01+.0095*Math.pow(e/28,2)),s=1+t*.4;return r*9.81*i*s}function le(e,t=63){let r=t/100*Math.PI;return e/r}function Z(e,t,r){let n=B(e,0,t),o=A(e,r);return n+o}function ge(e,t,r){let n=Z(e,t,r),o=N();return e*(n/o)/1e3}function m(e,t,r,n=63){if(!e)return null;let o=r||_(t),i=e*o*t,s=n/100/2;return i/s}function _(e){let s=(e-5)*.007333333333333332;return Math.max(.96-s,.85)}function j(e,t){return e===null?null:t?e*t/9549:0}function w(e,t){return e*9549/t}function U(e){return .73549875*e}function A(e,t){return .6*Math.pow(e,2)*t}function v(e,t,r){var n=e.find(a=>a[0]===t);if(n)return n[1];var o=e.findIndex(a=>a[0]>t);if(o<=0)return null;var i=e[o-1],s=e[o],u=s[0]-i[0],c=(t-i[0])/u,f=s[1]-i[1],l=i[1]+f*c;return r&&j(l,t)>r&&(l=w(r,t)),l}function ee(e,t=1e3){typeof t=="string"&&(t=parseInt(t));let r=0;const n=/(\d+)(\w+)@(\d+)/ig,i=[...e.matchAll(n)].map(s=>{const u=parseFloat(s[1]),c=s[2],f=parseInt(s[3]);let l=u;return/hp/.test(c)&&(l=w(U(u),f)),/kw/.test(c)&&(l=w(u,f)),r=Math.max(r,l),[f,l]});return i.length&&i[0][0]>t&&i.unshift([t,r*.7]),i}function te(e,t,r){if(typeof e=="string"){const s=e.match(/(\d+\.*\d+)(\D*)/);r=s[2],e=parseFloat(s[1])}if(!t&&!r)return{value:e,unit:"?"};let n,o=0;for(;!n&&o<D.length;)n=i(D[o],t,r),o++;function i(s,u,c){let f,l;for(var a=0;a<s.length;a++){var g=s[a];if(typeof g!="number"&&(u?!f&&new RegExp(`^${u}$`,"i").test(g)&&(a===0?f=1:f=s[a+1]):(u=s[0],f=1),c?!l&&new RegExp(`^${c}$`,"i").test(g)&&(a===0?l=1:l=s[a+1]):(c=s[0],l=1),f&&l))return{toUnit:u,toUnitRatio:f,fromUnit:c,fromUnitRatio:l}}return null}return e=e/n.fromUnitRatio*n.toUnitRatio,{value:e,unit:n.toUnit}}const D=[["kw","hp",1.341,"bhp",1.3596],["nm","ftlb",.7376]];let ne=0;class ue{constructor(t){b(this,"id");b(this,"props");b(this,"state",{speed:0,engineRpm:0,enginePower:0,engineTorque:0,force:0,acceleration:0,airDrag:0,throttleInput:0,brakeInput:0,gearInput:0});b(this,"inputs",{throttle:0,brake:0,gear:0,gearT:0});this.id=ne++,this.props=t}updateEngineRPM(){const{engine:t,wheelDiameter:r}=this.props,n=this.state;let o=t.minRPM||1e3;const i=this.getTransmissionFinalRatio();let s=Math.max(k(n.speed,i,r),o);this.state.engineRpm=s}getTransmissionFinalRatio(){const{gearRatio:t,driveRatio:r,gearTransfer:n}=this.props.gearbox,o=this.inputs;return r*t[o.gear]*(n?n[o.gearT]:1)}getEndForce(){const{engine:t,wheelDiameter:r}=this.props,n=this.state,o=this.inputs,i=this.getTransmissionFinalRatio();let s=v(t.torqueCurve,n.engineRpm,t.power)*o.throttle;return m(s,i,null,r)}}function ce(e,t){let r=t/1e3;const{engine:n,gearbox:o,gearSpeed:i,weight:s,dragCoef:u,dragArea:c,brakePadsForce:f,wheelDiameter:l}=e.props,{speed:a,engineRpm:g,throttleInput:p,brakeInput:x,gearInput:W}=e.state,{gearRatio:X,driveRatio:I,gearTransfer:q}=o;let G=B(a,e.state.acceleration,s),E=A(a,u*c),h=v(n.torqueCurve,g,n.power)*p,$=j(h,g),K=x*f;const H=s;let P=I*X[W]*(q?q[0]:1),R=m(h,P,null,l),V=n.minRPM||1e3,M=Math.max(k(a,P,l),V);if(e.props.type==="plane")if(e.props.engine.thrust)R=e.props.engine.thrust*p,console.log(R);else{M=2700;const Y=5.325,z=200;h=v(n.torqueCurve,g,n.power),R=m(h,Y,1,z)}let T=(R-E-G-K)/H,y=T*r,Q={speed:Math.max(a+(y||0),0),engineRpm:M,acceleration:T,thrustForce:R,aeroDragForce:E,torque:h,power:$};return Object.assign(e,{state:Object.assign(e.state,Q)})}function fe(){return d.car.list()}function pe(e,t=0,r=0,n,o){console.log("getting car",e,t,r,n,o);let i=d.car.get(e);if(!i)throw Error("car not found");const s=F(i),u=[].concat({trim:i.trim||"default"},i.trims||[]);i=Object.assign({},i,u[t]);let c=re(i);c=c.map(a=>{let g=Object.assign({},a),p=g.engine;if(!S(p)){let x=d.engine.find(p);g.engine=x}return g});var f=c[r];i=Object.assign({},i,f);const l=[].concat({engine:i.engine},i.engines?i.engines.reduce((a,g)=>g.engine&&g.engine.name?a.concat(g):a,[]):[]);if(l.forEach(a=>{let g=a.engine;if(!S(g)){let p=d.engine.find(g);a.engine=p}}),n>=l.length&&(n=0),i=Object.assign({},i,l[n]),typeof i.gearbox=="string"){let a=s.find(g=>g.name===i.gearbox);i.gearbox=a||O.gearbox}return i=ie(i),Object.assign(Object.create(O),i,{trims:u,configs:c},{trimId:t,configId:r})}function re(e){var t=[],r=[].concat(e.engine,...e.engines||[]).filter(Boolean),n=[].concat(e.gearbox,...e.gearboxes||[]).filter(Boolean);if(e.configs)return e.engine&&t.push({engine:e.engine,gearbox:n[0]}),t.concat(e.configs);for(var o=0;o<r.length;o++){n.length===0&&t.push({engine:r[o]});for(var i=0;i<n.length;i++)t.push({engine:r[o],gearbox:n[i]})}return t}function F(e){let t=[];if(e.gearbox&&C(e.gearbox)&&t.push(e.gearbox),e.gearboxes&&e.gearboxes.forEach(n=>{C(n)&&t.push(n)}),e.configs&&e.configs.forEach(n=>{let o=F(n);t.push(...o)}),e.trims&&e.trims.length>0)for(var r=0;r<e.trims.length;r++){let n=F(e.trims[r]);t.push(...n)}return t}function C(e){return!(typeof e!="object"||!e.name)}function he(e){return d.car.search(e)}function S(e){return e?!!(e.spec||e.torqueX):!1}function ie(e){var t=Object.assign({},e.engine);if(!t.torqueCurve)if(t.torqueX){let r=[];for(let n=0;n<t.torqueX.length;n++){let o=t.torqueXMultiplier?t.torqueXMultiplier:1;r.push([t.torqueX[n]*o,t.torqueY[n]])}t.torqueCurve=r}else t.spec&&(t.torqueCurve=ee(t.spec));return t.power=te(t.power).value,e.engine=t,e}const O={weight:1e3,height:1600,width:1600,length:4e3,wheelDiameter:63,dragCoef:.3,dragArea:2,brakePadsForce:12e3,gearbox:{gearRatio:[4,2,1],driveRatio:4}};export{ue as C,pe as a,v as b,Z as c,k as d,m as e,ge as f,le as g,ae as h,te as i,fe as l,he as s,j as t,ce as u};
