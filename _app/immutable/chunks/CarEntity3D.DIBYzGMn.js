var x=Object.defineProperty;var E=(r,e,t)=>e in r?x(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var p=(r,e,t)=>E(r,typeof e!="symbol"?e+"":e,t);import{C as v,N as w,a as b,l as T,b as S,O as B,T as D,S as P,c as I}from"./loader.CaIUhdO0.js";import{g as M}from"./index.JSGz7vAS.js";const F={blue:[[64,122,171],[46,99,144],[80,137,186]],red:[[197,41,67],[161,20,43],[209,66,89]],orange:[[220,130,50],[184,105,34],[221,148,83]],green:[[72,147,77],[56,125,61],[121,169,125]],purple:[[144,92,168],[118,69,138],[161,121,177]]},C=[[245,245,245],[210,210,210],[255,255,255]];function L(r,e){if(!r)return null;const t=document.createElement("canvas"),s=t.getContext("2d");t.width=r.image.width,t.height=r.image.height,s.drawImage(r.image,0,0);const i=s.getImageData(0,0,t.width,t.height),o=O(i),a=F[e]||C;R(i,o,a),s.putImageData(i,0,0);const n=new v(t);return n.needsUpdate=!0,n.minFilter=w,n.magFilter=b,n.flipY=!1,n}function O(r){const e=[];for(let t=0;t<20;t+=4){const[s,i,o]=r.data.slice(t,t+3);j([s,i,o],e)<0&&e.push([s,i,o])}return e}function R(r,e,t){for(let s=0;s<r.data.length;s+=4){const[i,o,a]=r.data.slice(s,s+3),n=j([i,o,a],e);if(n>=0){const[l,c,d]=t.length>n?t[n]:[i,o,a];r.data.set([l,c,d],s)}}return r}function j([r,e,t],s){return s.findIndex(i=>i[0]===r&&i[1]===e&&i[2]===t)}class N{constructor(e,{group:t,body:s,wheels:i,misc:o,propeller:a},n,l,c=!0){p(this,"carEntity");p(this,"object");p(this,"carBody");p(this,"wheels");p(this,"propeller");p(this,"lights");if(this.carEntity=e,this.object=t,this.carBody=s,this.propeller=a,this.wheels=[],i.forEach(h=>{let f=e.props.wheelScale?e.props.wheelScale[h.index-1]:1;const g=e.props.wheelDiameter;let u=new m(h.obj,n,g*f,h.index,h.isRight,!1);this.wheels.push(u),this.object.add(u)}),this.lights=U(this.carBody,this.carEntity.props.modelLights),c){const{wheelDiameter:h}=e.props;this.object.position.y+=h/250}o.forEach(h=>{this.object.remove(h.obj);const f=new RegExp(h.name,"i");if(e.props.modelMisc&&f.test(e.props.modelMisc))if(h.isWheel){const g=e.props.wheelDiameter;let u=new m(h.obj,n,g);this.carBody.add(u)}else this.carBody.add(h.obj)});const d=this.carBody.material.map,y=L(d,l);this.carBody.material.map=y,this.carBody.castShadow=!0,this.carBody.receiveShadow=!1}updateLights(e,t){this.lights.brake.forEach(s=>s.visible=e>0),this.lights.reverse.forEach(s=>s.visible=!!t)}animate(e){if(!this.object)return;const{speed:t,acceleration:s}=this.carEntity.state,{wheelDiameter:i}=this.carEntity.props;let a=M(t,i)*(e/1e3)*Math.PI*2,n=.25;for(let c=0;c<this.wheels.length;c++)this.wheels[c].rotateX(Math.min(n,a));this.object.position.z+=t*e/1e3;let l=s/4*(Math.PI/180);if(this.carBody.rotation.x=-l,this.propeller){const{engineRpm:c}=this.carEntity.state;let d=c/60*(e/1e3)*Math.PI*2;this.propeller.rotation.z+=Math.min(n,d)}}}var k=(r=>(r[r.Front=0]="Front",r[r.Rear=1]="Rear",r[r.Spare=2]="Spare",r))(k||{});class m extends B{constructor(t,s,i,o,a,n=!0){super();p(this,"object");p(this,"isRight");p(this,"wheelIndex");p(this,"wheelType");this.isRight=!!a,this.position.copy(t.position),n&&this.rotation.copy(t.rotation),this.object=s.clone();let l=z(i,s);this.object.scale.set(a?-l:l,l,l),this.wheelIndex=o,o<=2&&(this.wheelType=0),this.add(this.object)}}function z(r,e){const t=e.geometry.boundingBox.max.z*2*100;return r?r/t:1}function A(r,e=[0,0,0],t=[1,1,1]){const s=new D().load("sprites/effects/"+r+".png");s.minFilter=w,s.magFilter=b;const i=new P({map:s}),o=new I(i);return o.position.set(e[0],e[1],e[2]),o.scale.set(t[0],t[1],t[2]),o.visible=!1,o}function U(r,e){const t={brake:[],reverse:[]},s={brake:"redlight",reverse:"whitelight"};if(e)for(const[i,o]of Object.entries(e))t[i]=e[i].map(a=>{let n=[a[0],a[1],a[2]],l=a.length>3?[a[3],a[3],a[3]]:[.4,.4,.4],c=A(s[i],n,l);return r.add(c),c});return t}async function Y(r,e,t){let s;const i=r.props;return T(i.modelWheel).then(o=>s=o).then(()=>S(i)).then(o=>new N(r,o,s,e,t))}export{k as W,Y as c};
