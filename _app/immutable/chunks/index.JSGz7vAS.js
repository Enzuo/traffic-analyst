var J=Object.defineProperty;var L=(e,t,n)=>t in e?J(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var b=(e,t,n)=>L(e,typeof t!="symbol"?t+"":t,n);import{d as m}from"./uPlot.min.Sk6Afor8.js";function O(e,t,n=63){return e/(n/100*Math.PI)*t*60}function ae(e,t,n,r=63){return e/60/(t*n)*(r/100*Math.PI)}function N(e,t){return .85}function B(e,t,n){let i=.005+.4*(.01+.0095*Math.pow(e/28,2)),s=1+t*.4;return n*9.81*i*s}function le(e,t=63){let n=t/100*Math.PI;return e/n}function Z(e,t,n){let r=B(e,0,t),o=A(e,n);return r+o}function ue(e,t,n){let r=Z(e,t,n),o=N();return e*(r/o)/1e3}function d(e,t,n,r=63){if(!e)return null;let o=n||_(t),i=e*o*t,s=r/100/2;return i/s}function _(e){let s=(e-5)*.007333333333333332;return Math.max(.96-s,.85)}function j(e,t){return e===null?null:t?e*t/9549:0}function w(e,t){return e*9549/t}function U(e){return .73549875*e}function A(e,t){return .6*Math.pow(e,2)*t}function v(e,t,n){var r=e.find(a=>a[0]===t);if(r)return r[1];var o=e.findIndex(a=>a[0]>t);if(o<=0)return null;var i=e[o-1],s=e[o],u=s[0]-i[0],c=(t-i[0])/u,f=s[1]-i[1],l=i[1]+f*c;return n&&j(l,t)>n&&(l=w(n,t)),l}function ee(e,t=1e3){typeof t=="string"&&(t=parseInt(t));let n=0;const r=/(\d+)(\w+)@(\d+)/ig,i=[...e.matchAll(r)].map(s=>{const u=parseFloat(s[1]),c=s[2],f=parseInt(s[3]);let l=u;return/hp/.test(c)&&(l=w(U(u),f)),/kw/.test(c)&&(l=w(u,f)),n=Math.max(n,l),[f,l]});return i.length&&i[0][0]>t&&i.unshift([t,n*.7]),i.toSorted((s,u)=>s[0]-u[0])}function te(e,t,n){if(typeof e=="string"){const s=e.match(/(\d+\.*\d+)(\D*)/);n=s[2],e=parseFloat(s[1])}if(!t&&!n)return{value:e,unit:"?"};let r,o=0;for(;!r&&o<D.length;)r=i(D[o],t,n),o++;function i(s,u,c){let f,l;for(var a=0;a<s.length;a++){var g=s[a];if(typeof g!="number"&&(u?!f&&new RegExp(`^${u}$`,"i").test(g)&&(a===0?f=1:f=s[a+1]):(u=s[0],f=1),c?!l&&new RegExp(`^${c}$`,"i").test(g)&&(a===0?l=1:l=s[a+1]):(c=s[0],l=1),f&&l))return{toUnit:u,toUnitRatio:f,fromUnit:c,fromUnitRatio:l}}return null}return e=e/r.fromUnitRatio*r.toUnitRatio,{value:e,unit:r.toUnit}}const D=[["kw","hp",1.341,"bhp",1.359,"ps",1.35962],["nm","ftlb",.7376,"mkg",.10197]];let ne=0;class ge{constructor(t){b(this,"id");b(this,"props");b(this,"state",{speed:0,engineRpm:0,enginePower:0,engineTorque:0,force:0,acceleration:0,airDrag:0,throttleInput:0,brakeInput:0,gearInput:0});b(this,"inputs",{throttle:0,brake:0,gear:0,gearT:0});this.id=ne++,this.props=t}updateEngineRPM(){const{engine:t,wheelDiameter:n}=this.props,r=this.state;let o=t.minRPM||1e3;const i=this.getTransmissionFinalRatio();let s=Math.max(O(r.speed,i,n),o);this.state.engineRpm=s}getTransmissionFinalRatio(){const{gearRatio:t,driveRatio:n,gearTransfer:r}=this.props.gearbox,o=this.inputs;return n*t[o.gear]*(r?r[o.gearT]:1)}getEndForce(){const{engine:t,wheelDiameter:n}=this.props,r=this.state,o=this.inputs,i=this.getTransmissionFinalRatio();let s=v(t.torqueCurve,r.engineRpm,t.power)*o.throttle;return d(s,i,null,n)}}function ce(e,t){let n=t/1e3;const{engine:r,gearbox:o,gearSpeed:i,weight:s,dragCoef:u,dragArea:c,brakePadsForce:f,wheelDiameter:l}=e.props,{speed:a,engineRpm:g,throttleInput:p,brakeInput:x,gearInput:W}=e.state,{gearRatio:X,driveRatio:I,gearTransfer:q}=o;let G=B(a,e.state.acceleration,s),E=A(a,u*c),h=v(r.torqueCurve,g,r.power)*p,$=j(h,g),K=x*f;const H=s;let P=I*X[W]*(q?q[0]:1),R=d(h,P,null,l),V=r.minRPM||1e3,M=Math.max(O(a,P,l),V);if(e.props.type==="plane")if(e.props.engine.thrust)R=e.props.engine.thrust*p,console.log(R);else{M=2700;const Y=5.325,z=200;h=v(r.torqueCurve,g,r.power),R=d(h,Y,1,z)}let T=(R-E-G-K)/H,y=T*n,Q={speed:Math.max(a+(y||0),0),engineRpm:M,acceleration:T,thrustForce:R,aeroDragForce:E,torque:h,power:$};return Object.assign(e,{state:Object.assign(e.state,Q)})}function fe(){return m.car.list()}function pe(e,t=0,n=0,r,o){console.log("getting car",e,t,n,r,o);let i=m.car.get(e);if(!i)throw Error("car not found");const s=F(i),u=[].concat({trim:i.trim||"default"},i.trims?i.trims.filter(a=>a.trim):[]);i=Object.assign({},i,u[t]);let c=re(i);c=c.map(a=>{let g=Object.assign({},a),p=g.engine;if(!C(p)){let x=m.engine.find(p);g.engine=x}return g});var f=c[n];i=Object.assign({},i,f);const l=[].concat({engine:i.engine},i.engines?i.engines.reduce((a,g)=>g.engine&&g.engine.name?a.concat(g):a,[]):[]);if(l.forEach(a=>{let g=a.engine;if(!C(g)){let p=m.engine.find(g);a.engine=p}}),r>=l.length&&(r=0),i=Object.assign({},i,l[r]),typeof i.gearbox=="string"){let a=s.find(g=>g.name===i.gearbox);i.gearbox=a||k.gearbox}return i=ie(i),Object.assign(Object.create(k),i,{trims:u,configs:c},{trimId:t,configId:n})}function re(e){var t=[],n=[].concat(e.engine,...e.engines||[]).filter(Boolean),r=[].concat(e.gearbox,...e.gearboxes||[]).filter(Boolean);if(e.configs)return e.engine&&t.push({engine:e.engine,gearbox:r[0]}),t.concat(e.configs);for(var o=0;o<n.length;o++){r.length===0&&t.push({engine:n[o]});for(var i=0;i<r.length;i++)t.push({engine:n[o],gearbox:r[i]})}return t}function F(e){let t=[];if(e.gearbox&&S(e.gearbox)&&t.push(e.gearbox),e.gearboxes&&e.gearboxes.forEach(r=>{S(r)&&t.push(r)}),e.configs&&e.configs.forEach(r=>{let o=F(r);t.push(...o)}),e.trims&&e.trims.length>0)for(var n=0;n<e.trims.length;n++){let r=F(e.trims[n]);t.push(...r)}return t}function S(e){return!(typeof e!="object"||!e.name)}function he(e){return m.car.search(e)}function C(e){return e?!!(e.spec||e.torqueX):!1}function ie(e){var t=Object.assign({},e.engine);if(!t.torqueCurve)if(t.torqueX){let n=[];for(let r=0;r<t.torqueX.length;r++){let o=t.torqueXMultiplier?t.torqueXMultiplier:1;n.push([t.torqueX[r]*o,t.torqueY[r]])}t.torqueCurve=n}else t.spec&&(t.torqueCurve=ee(t.spec));return t.power=te(t.power).value,e.engine=t,e}const k={weight:1e3,height:1600,width:1600,length:4e3,wheelDiameter:63,dragCoef:.3,dragArea:2,brakePadsForce:12e3,gearbox:{gearRatio:[4,2,1],driveRatio:4}};function Re(e){if(!e)return[null,null];if(typeof e=="number")return[e,e];const t=e.match(/\d+/g).map(n=>parseInt(n,10));return t.length<2?[t[0],t[0]]:t[0]>t[1]?[t[1],t[0]]:[t[0],t[1]]}export{ge as C,pe as a,v as b,Z as c,O as d,d as e,ue as f,le as g,ae as h,te as i,fe as l,Re as p,he as s,j as t,ce as u};
