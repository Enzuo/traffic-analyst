var x=Object.defineProperty;var j=(e,t,o)=>t in e?x(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var h=(e,t,o)=>(j(e,typeof t!="symbol"?t+"":t,o),o);import{k as y,N as E,l as D,m as T,n as B,O as P}from"./loader.04de8719.js";import{i as S}from"./index.e789bfc7.js";const I={blue:[[64,122,171],[46,99,144],[80,137,186]],red:[[197,41,67],[161,20,43],[209,66,89]],orange:[[220,130,50],[184,105,34],[221,148,83]],green:[[72,147,77],[56,125,61],[121,69,125]],purple:[[144,92,168],[118,69,138],[161,121,177]]},M=[[245,245,245],[210,210,210],[255,255,255]];function v(e,t){if(!e)return null;const o=document.createElement("canvas"),r=o.getContext("2d");o.width=e.image.width,o.height=e.image.height,r.drawImage(e.image,0,0);const n=r.getImageData(0,0,o.width,o.height),i=C(n),a=I[t]||M;F(n,i,a),r.putImageData(n,0,0);const s=new y(o);return s.needsUpdate=!0,s.minFilter=E,s.magFilter=D,s.flipY=!1,s}function C(e){const t=[];for(let o=0;o<20;o+=4){const[r,n,i]=e.data.slice(o,o+3);g([r,n,i],t)<0&&t.push([r,n,i])}return t}function F(e,t,o){for(let r=0;r<e.data.length;r+=4){const[n,i,a]=e.data.slice(r,r+3),s=g([n,i,a],t);if(s>=0){const[l,p,d]=o.length>s?o[s]:[n,i,a];e.data.set([l,p,d],r)}}return e}function g([e,t,o],r){return r.findIndex(n=>n[0]===e&&n[1]===t&&n[2]===o)}class R{constructor(t,{group:o,body:r,wheels:n,misc:i,propeller:a},s,l){h(this,"carEntity");h(this,"object");h(this,"carBody");h(this,"wheels");h(this,"propeller");this.carEntity=t,this.object=o,this.carBody=r,this.propeller=a,this.wheels=[],n.forEach(c=>{let m=t.props.wheelScale?t.props.wheelScale[c.index-1]:1;const w=t.props.wheelDiameter;let u=new f(c.obj,s,w*m,c.index,c.isRight,!1);this.wheels.push(u),this.object.add(u)});const{wheelDiameter:p}=t.props;this.object.position.y+=p/250,i.forEach(c=>{this.object.remove(c.obj);const m=new RegExp(c.name,"i");if(t.props.modelMisc&&m.test(t.props.modelMisc))if(c.isWheel){const w=t.props.wheelDiameter;let u=new f(c.obj,s,w);this.carBody.add(u)}else this.carBody.add(c.obj)});const d=this.carBody.material.map,b=v(d,l);this.carBody.material.map=b,this.carBody.castShadow=!0,this.carBody.receiveShadow=!1}animate(t){if(!this.object)return;const{speed:o,acceleration:r}=this.carEntity.state,{wheelDiameter:n}=this.carEntity.props;let a=S(o,n)*(t/1e3)*Math.PI*2,s=.25;for(let p=0;p<this.wheels.length;p++)this.wheels[p].rotateX(Math.min(s,a));this.object.position.z+=o*t/1e3;let l=r/4*(Math.PI/180);if(this.carBody.rotation.x=-l,this.propeller){const{engineRpm:p}=this.carEntity.state;let d=p/60*(t/1e3)*Math.PI*2;this.propeller.rotation.z+=Math.min(s,d)}}}var N=(e=>(e[e.Front=0]="Front",e[e.Rear=1]="Rear",e[e.Spare=2]="Spare",e))(N||{});class f extends P{constructor(o,r,n,i,a,s=!0){super();h(this,"object");h(this,"side");h(this,"wheelIndex");h(this,"wheelType");this.position.copy(o.position),s&&this.rotation.copy(o.rotation),this.object=r.clone();let l=O(n,r);this.object.scale.set(a?-l:l,l,l),this.wheelIndex=i,i<=2&&(this.wheelType=0),this.add(this.object)}}function O(e,t){const o=t.geometry.boundingBox.max.z*2*100;return e?e/o:1}async function U(e,t){let o;const r=e.props;return T(r.modelWheel).then(n=>o=n).then(()=>B(r)).then(n=>new R(e,n,o,t))}export{N as W,U as c};
